
<html>

<head>
<title>ZZT</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<script type='text/javascript' src='mootools-core.js'></script>
<script type='text/javascript' src='jDataView.js'></script>
<script type='text/javascript' src='terminal.js'></script>
<script type='text/javascript' src='speaker.js'></script>
<script type='text/javascript' src='zzt.js'></script>
<script type="text/javascript">

var world = null;
var terminal = null;
var curBoard = 0;
var maxBoards = 0;

window.addEvent('domready', function(e) {
    $$('input#loadButton').each(function(button) {
        button.addEvent('click', function(e) {
            var name = button.value;
            load(name);
        });
    });
    
    $('prevButton').addEvent('click', function() {
        if (world) {
            if (curBoard > 0) {
                curBoard--;
                world.showBoard(curBoard);
            }
        }
    });
    
    $('nextButton').addEvent('click', function() {
        if (world) {
            if (curBoard < maxBoards-1) {
                curBoard++;
                world.showBoard(curBoard);
            }
        }
    });
    
    terminal = new Terminal();
    terminal.setupTerminal();
    terminal.clear();
    
    if ( !window.requestAnimationFrame ) {
        window.requestAnimationFrame = ( function() {
     
            return window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            function( /* function FrameRequestCallback */ callback, /* DOMElement Element */ element ) {
     
                window.setTimeout( callback, 1000 / 60 );
     
            };
     
        } )();
    }
    //beep(0, 500);
});

function animLoop( render, element ) {
    var running, lastFrame = +new Date;
    var frame = 0;
    var nextPoint = 0;
    var pointDuration = 60;
    
    function loop( now ) {
        // stop the loop if render returned false
        if ( running !== false ) {
            requestAnimationFrame( loop, element );
            var deltaT = now - lastFrame;
            // do not render frame when deltaT is too high
            // skip a few frames, give deltaT a moment to smooth out
            if (frame > 5) {
                if ( deltaT < 160 ) {
                    running = render( deltaT );
                }
            }
            lastFrame = now;
            frame++;
        }
    }
    loop( lastFrame );
}

function load(name) {
    var xhr = new XMLHttpRequest();
    xhr.overrideMimeType("text/plain; charset=x-user-defined");
        
    xhr.onload = function(e) {
        //console.log('loading world');
        var arraybuffer = xhr.response;
        if (arraybuffer) {
            var data = new jDataView(arraybuffer,0,arraybuffer.length,true); // we need to parse 16/32 bit values as little endian
            setTimeout(function() {
                var magic = data.getInt16();
                if (magic == -1) {
                    world = new ZZTWorld(data);
                    world.showBoard(0);
                }
            }, 100);
        }
    }
    
    xhr.open('GET', '/zzt/' + name, true);
    xhr.send();
}

</script>
</head>

<body style='background:#222'>
    <div style='position:absolute;margin:auto;width:540px;height:400px;left:0;top:0;bottom:0;right:0'>
        <div style='float:right;margin-right:-160px;width:150px;font:10px verdana;color:#fa0'>
            <div style='float:left'>
                <div>Ammo:</div>
                <div>Gems:</div>
                <div>Health:</div>
                <div>Torches:</div>
                <div>Keys:</div>
            </div>
            <div style='float:right;text-align:right'>
                <div id='ammo'></div>
                <div id='gems'></div>
                <div id='health'></div>
                <div id='torches'></div>
                <div id='keys'>
                    <div style='float:left;color:#00f;font-weight:bold'>&#9792;</div>
                    <div style='float:left;color:#0f0;font-weight:bold'>&#9792;</div>
                    <div style='float:left;color:#0ff;font-weight:bold'>&#9792;</div>
                    <div style='float:left;color:#f00;font-weight:bold'>&#9792;</div>
                    <div style='float:left;color:#f0f;font-weight:bold'>&#9792;</div>
                    <div style='float:left;color:#ff0;font-weight:bold'>&#9792;</div>
                    <div style='float:left;color:#fff;font-weight:bold'>&#9792;</div>
                </div>
            </div>
        </div>
        <canvas style='background:#000' id='canvas' width='540' height='400'>
            if you can see this...get a better browser
        </canvas>
        <div style='margin-top:10px;text-align:center'>
            <input type='button' id='prevButton' value='previous board'>
            <input type='button' id='nextButton' value='next board'>
        </div>
        
    </div>
    <input type='button' id='loadButton' value='TOWN.ZZT'>
    <input type='button' id='loadButton' value='CAVES.ZZT'>
    <input type='button' id='loadButton' value='CITY.ZZT'>
    <input type='button' id='loadButton' value='DUNGEONS.ZZT'>
</body>

</html>
