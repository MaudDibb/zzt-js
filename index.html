
<html>

<head>
<title>ZZT</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<script type='text/javascript' src='mootools-core.js'></script>
<script type='text/javascript' src='jDataView.js'></script>
<script type='text/javascript' src='terminal.js'></script>
<script type='text/javascript' src='zzt.js'></script>
<script type="text/javascript">

var world = null;
var terminal = null;
var curBoard = 0;
var maxBoards = 0;

var beep = function(duration, type, finishedCallback) {

    if (!(window.audioContext || window.webkitAudioContext)) {
        throw Error("Your browser does not support Audio Context.");
    }

    duration = +duration;

    // Only 0-4 are valid types.
    type = (type % 5) || 0;

    if (typeof finishedCallback != "function") {
        finishedCallback = function() {};   
    }

    var ctx = new (window.audioContext || window.webkitAudioContext);
    var osc = ctx.createOscillator();

    osc.type = type;

    osc.connect(ctx.destination);
    osc.noteOn(0);

    setTimeout(function() {
        osc.noteOff(0);
        finishedCallback();
    }, duration);

};

window.addEvent('domready', function(e) {
    $$('input#loadButton').each(function(button) {
        button.addEvent('click', function(e) {
            var name = button.value;
            load(name);
        });
    });
    
    $('prevButton').addEvent('click', function() {
        if (world) {
            if (curBoard > 0) {
                curBoard--;
                world.showBoard(curBoard);
            }
        }
    });
    
    $('nextButton').addEvent('click', function() {
        if (world) {
            if (curBoard < maxBoards-1) {
                curBoard++;
                world.showBoard(curBoard);
            }
        }
    });
    
    terminal = new Terminal();
    terminal.setupTerminal();
    terminal.clear();
    
    //beep(0, 500);
});

function load(name) {
    var xhr = new XMLHttpRequest();
    xhr.overrideMimeType("text/plain; charset=x-user-defined");
        
    xhr.onload = function(e) {
        console.log('loading world');
        var arraybuffer = xhr.response;
        if (arraybuffer) {
            var data = new jDataView(arraybuffer,0,arraybuffer.length,true); // we need to parse 16/32 bit values as little endian
            setTimeout(function() {
                var magic = data.getInt16();
                if (magic == -1) {
                    world = new ZZTWorld(data);
                    world.showBoard(0);
                }
            }, 100);
        }
    }
    
    xhr.open('GET', '/zzt/' + name, true);
    xhr.send();
}

</script>
</head>

<body style='background:#222'>
    <div style='position:absolute;margin:auto;width:540px;height:400px;left:0;top:0;bottom:0;right:0'>
        <canvas style='background:#000' id='canvas' width='540' height='400'>
            if you can see this...get a better browser
        </canvas>
        <div style='margin-top:10px;text-align:center'>
            <input type='button' id='prevButton' value='previous board'>
            <input type='button' id='nextButton' value='next board'>
        </div>
    </div>
    <input type='button' id='loadButton' value='TOWN.ZZT'>
    <input type='button' id='loadButton' value='CAVES.ZZT'>
    <input type='button' id='loadButton' value='CITY.ZZT'>
    <input type='button' id='loadButton' value='DUNGEONS.ZZT'>
</body>

</html>
